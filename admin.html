<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Gest√£o Exclusiva Noivas | Painel de Controle</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --gold: #b89754; --dark: #1a1a1a; --off-white: #fdfaf7; --red: #ff4d4d; --green: #2ecc71; --blue: #3b82f6; --yellow: #f1c40f; }
        body { font-family: 'Garamond', serif; background-color: var(--off-white); padding: 20px; color: var(--dark); }
        .container { max-width: 1100px; margin: auto; background: white; padding: 40px; border-top: 5px solid var(--gold); box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        
        .header-admin { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 20px; margin-bottom: 20px; }
        h1 { text-transform: uppercase; letter-spacing: 3px; font-size: 20px; margin: 0; }
        
        .dashboard-bar { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .dash-card { background: #fff; border: 1px solid #eee; padding: 20px; text-align: center; border-radius: 4px; border-top: 3px solid var(--gold); }
        .dash-val { display: block; font-size: 24px; font-weight: bold; color: var(--gold); }
        .dash-label { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: #999; }

        /* Estilos Dashboard Visual na Aba Pr√≥pria */
        #abaDashboardVisual { display: none; }
        .charts-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; background: #fdfaf7; padding: 20px; border-radius: 8px; border: 1px solid #eee; }
        .chart-box { background: white; padding: 15px; border-radius: 4px; height: 350px; display: flex; flex-direction: column; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .chart-box h3 { font-size: 12px; text-transform: uppercase; margin-bottom: 15px; color: var(--gold); }

        /* Grid para Cliques */
        .cliques-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .clique-card { background: white; padding: 15px; border-radius: 4px; border-bottom: 3px solid var(--gold); box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: center; }
        .clique-val { font-size: 20px; font-weight: bold; color: var(--dark); display: block; }
        .clique-label { font-size: 9px; text-transform: uppercase; color: #999; letter-spacing: 1px; }

        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--off-white); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 50px; border-top: 4px solid var(--gold); box-shadow: 0 10px 30px rgba(0,0,0,0.05); text-align: center; width: 100%; max-width: 350px; }
        .login-box input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; font-family: 'Garamond', serif; font-size: 16px; box-sizing: border-box; }
        #painelConteudo { display: none; }

        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; flex-wrap: wrap; }
        .tab-btn { background: none; border: none; padding: 10px 20px; cursor: pointer; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: #999; border-bottom: 2px solid transparent; transition: 0.3s; }
        .tab-btn.active { color: var(--gold); border-bottom: 2px solid var(--gold); font-weight: bold; }

        .filter-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: #f9f9f9; padding: 15px; border-radius: 4px; }
        .filter-group { display: flex; align-items: center; gap: 10px; font-size: 13px; }
        .month-select { padding: 5px; border: 1px solid #ccc; font-family: 'Garamond', serif; }

        table { width: 100%; border-collapse: collapse; font-size: 14px; margin-bottom: 30px; }
        th { text-align: left; background: #f9f9f9; padding: 12px; border-bottom: 2px solid var(--gold); text-transform: uppercase; font-size: 11px; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        
        .group-header { background: #fdfaf7; padding: 10px 15px; font-weight: bold; font-size: 11px; text-transform: uppercase; letter-spacing: 2px; color: var(--gold); border-left: 4px solid var(--gold); margin: 20px 0 10px 0; }

        .status-pendente { color: #d97706; font-weight: bold; }
        .status-agendado { color: var(--blue); font-weight: bold; }
        .status-confirmado { color: var(--green); font-weight: bold; }
        .status-recusado { color: var(--red); font-weight: bold; }
        .status-finalizado { color: var(--dark); font-weight: bold; }
        
        .btn { padding: 8px 12px; border: none; cursor: pointer; font-size: 10px; text-transform: uppercase; letter-spacing: 1.2px; color: white; transition: 0.3s; }
        .btn-info { background: #3b82f6; margin-right: 5px; }
        .btn-aceitar { background: #10b981; margin-right: 5px; }
        .btn-confirmar-final { background: #059669; margin-right: 5px; }
        .btn-recusar { background: #ef4444; }
        .btn-reativar { background: var(--gold); }
        .btn-novo { background: var(--dark); padding: 12px 20px; font-size: 12px; letter-spacing: 2px; }
        .btn-expediente { background: var(--gold); }
        .btn-whatsapp { background: #25d366; margin-left: 5px; }
        .btn-finalizar { background: #6366f1; margin-left: 5px; }
        .btn-editar { background: #8b5cf6; margin-right: 5px; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 40px; width: 95%; max-width: 800px; border-top: 4px solid var(--gold); position: relative; max-height: 95vh; overflow-y: auto; text-align: center; }
        .close-modal { position: absolute; top: 15px; right: 20px; cursor: pointer; font-size: 24px; color: #999; }
        
        .grid-form { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: left; }
        .grid-form div { display: flex; flex-direction: column; }
        .section-title { text-align: left; font-weight: bold; color: var(--gold); text-transform: uppercase; font-size: 11px; margin: 15px 0 5px 0; border-bottom: 1px solid #eee; padding-bottom: 3px; }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 10px; background: #eee; padding: 5px; }
        .cal-day { background: white; min-height: 90px; padding: 8px; font-size: 12px; cursor: pointer; border: 1px solid #ddd; display: flex; flex-direction: column; justify-content: space-between; text-align: left; }
        .cal-header { font-weight: bold; background: var(--dark); color: white; padding: 10px 0; font-size: 10px; text-align: center; }
        .dia-fechado { background-color: var(--red) !important; color: white; }
        .dia-longo { background-color: var(--green) !important; color: white; }
        .dia-curto { background-color: var(--yellow) !important; color: #333; }
        .dia-padrao { background-color: var(--off-white); }
        .agendamento-count { background: rgba(0,0,0,0.1); border-radius: 10px; padding: 2px 6px; font-size: 9px; align-self: flex-end; font-weight: bold; }

        .info-card-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: left; margin-top: 20px; }
        .info-card-item { border-bottom: 1px solid #f5f5f5; padding-bottom: 5px; }
        .info-card-label { font-size: 9px; text-transform: uppercase; color: var(--gold); font-weight: bold; display: block; }
        .header-perfil { border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px; }
        .header-perfil h2 { margin: 0; text-transform: uppercase; letter-spacing: 2px; font-size: 18px; color: var(--dark); }
        
        input, select, textarea { font-family: 'Garamond', serif; width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; box-sizing: border-box; }
        label { font-size: 11px; text-transform: uppercase; font-weight: bold; margin-top: 5px; display: block; text-align: left;}

        .lojista-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .badge-lembrete { font-size: 12px; margin-left: 5px; }
        
        .obs-box { grid-column: span 2; background: #fffdf9; border: 1px dashed var(--gold); padding: 10px; margin-top: 10px; font-style: italic; font-size: 13px; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-box">
        <h2 style="text-transform: uppercase; letter-spacing: 2px; font-size: 18px;">Acesso Restrito</h2>
        <p style="font-size: 12px; color: #666; margin-bottom: 20px;">Exclusiva Noivas - Gest√£o</p>
        <input type="text" id="userLogin" placeholder="Usu√°rio">
        <input type="password" id="passLogin" placeholder="Senha">
        <button class="btn btn-novo" style="width: 100%; margin-top: 10px;" onclick="verificarLogin()">Entrar no Painel</button>
    </div>
</div>

<div id="painelConteudo">
    <div class="container">
        <div class="header-admin">
            <h1>Gest√£o Exclusiva Noivas</h1>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-expediente" onclick="abrirModalExpediente()">üóìÔ∏è Calend√°rio de Expediente</button>
                <button class="btn btn-novo" onclick="abrirModalCadastro()">+ Nova Reserva Manual</button>
            </div>
        </div>

        <div class="dashboard-bar">
            <div class="dash-card"><span class="dash-label">Atendimentos (M√™s Ref)</span><span class="dash-val" id="statTotal">0</span></div>
            <div class="dash-card"><span class="dash-label">Alugu√©is Fechados</span><span class="dash-val" id="statAluguel">0</span></div>
            <div class="dash-card"><span class="dash-label">Taxa de Convers√£o</span><span class="dash-val" id="statConv">0%</span></div>
        </div>

        <div id="abaDashboardVisual">
            <div class="group-header">Interatividade no Portal (M√™s Ref)</div>
            <div class="cliques-grid">
                <div class="clique-card"><span class="clique-val" id="clkAgenda">0</span><span class="clique-label">Cliques Agenda</span></div>
                <div class="clique-card"><span class="clique-val" id="clkWhats">0</span><span class="clique-label">Consultoria Whats</span></div>
                <div class="clique-card"><span class="clique-val" id="clkInsta">0</span><span class="clique-label">Galeria Insta</span></div>
                <div class="clique-card"><span class="clique-val" id="clkMaps">0</span><span class="clique-label">Localiza√ß√£o</span></div>
            </div>

            <div class="charts-container">
                <div class="chart-box">
                    <h3>Convers√£o Geral (%)</h3>
                    <canvas id="chartConversao"></canvas>
                </div>
                <div class="chart-box">
                    <h3>Ranking de Concorrentes</h3>
                    <canvas id="chartRanking"></canvas>
                </div>
            </div>
        </div>

        <div class="filter-bar">
            <div class="tabs">
                <button id="btn-tab-pendente" class="tab-btn active" onclick="filtrarStatus('pendente', this)">Pendentes</button>
                <button class="tab-btn" onclick="filtrarStatus('agendado', this)">Agendados</button>
                <button class="tab-btn" onclick="filtrarStatus('finalizado', this)">Finalizadas</button>
                <button class="tab-btn" onclick="filtrarStatus('recusado', this)">Recusados</button>
                <button class="tab-btn" onclick="filtrarStatus('dashboard', this)" style="background: #fdfaf7; color: var(--gold); border: 1px solid #eee; margin-left: 20px; font-weight: bold;">üìä Dashboard</button>
                <button class="tab-btn" onclick="filtrarStatus('lojistas', this)" style="background: #f0f0f0;">üè™ Lojistas</button>
            </div>
            <div class="filter-group" id="filtroDataContainer" style="display:none;">
                <label style="margin:0">M√™s Ref:</label>
                <select id="filtroMes" class="month-select" onchange="carregarDados();">
                    <option value="todos">Todos</option>
                    <option value="00">Janeiro</option><option value="01" selected>Fevereiro</option><option value="02">Mar√ßo</option>
                    <option value="03">Abril</option><option value="04">Maio</option><option value="05">Junho</option>
                    <option value="06">Julho</option><option value="07">Agosto</option><option value="08">Setembro</option>
                    <option value="09">Outubro</option><option value="10">Novembro</option><option value="11">Dezembro</option>
                </select>
            </div>
        </div>
        <div id="tabelaContainer"></div>
    </div>
</div>

<div id="modalExpediente" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="fecharModais()">√ó</span>
        <h2 style="text-transform: uppercase;">Calend√°rio de Trabalho</h2>
        <select id="filtroMesCalendario" class="month-select" onchange="gerarCalendarioVisivel()">
            <option value="00">Janeiro</option><option value="01" selected>Fevereiro</option><option value="02">Mar√ßo</option>
            <option value="03">Abril</option><option value="04">Maio</option><option value="05">Junho</option>
            <option value="06">Julho</option><option value="07">Agosto</option><option value="08">Setembro</option>
            <option value="09">Outubro</option><option value="10">Novembro</option><option value="11">Dezembro</option>
        </select>
        <div class="calendar-grid"><div class="cal-header">DOM</div><div class="cal-header">SEG</div><div class="cal-header">TER</div><div class="cal-header">QUA</div><div class="cal-header">QUI</div><div class="cal-header">SEX</div><div class="cal-header">S√ÅB</div></div>
        <div id="corpoCalendario" class="calendar-grid" style="margin-top:0;"></div>
    </div>
</div>

<div id="modalDiaEspecial" class="modal">
    <div class="modal-content" style="max-width: 400px;">
        <span class="close-modal" onclick="fecharModais()">√ó</span>
        <h3 id="tituloDiaEspecial">-</h3>
        <select id="e_status" onchange="toggleInputsEspecial()">
            <option value="padrao">Padr√£o</option>
            <option value="fechado">Bloquear</option>
            <option value="especial">Especial</option>
        </select>
        <div id="divHorariosEspeciais" style="display:none;">
            <input type="text" id="e_inicio" placeholder="09:30">
            <input type="text" id="e_fim" placeholder="18:00">
        </div>
        <button class="btn btn-novo" style="width:100%; margin-top:20px;" onclick="salvarConfigDia()">Salvar</button>
    </div>
</div>

<div id="modalDetalhes" class="modal">
    <div class="modal-content" style="max-width: 750px;">
        <span class="close-modal" onclick="fecharModais()">√ó</span>
        <div class="header-perfil"><h2 id="detalheNome">-</h2><p id="detalheData">-</p></div>
        <div id="detalhesNoiva" class="info-card-grid"></div>
        <button class="btn btn-novo" style="width:100%; margin-top:30px;" onclick="fecharModais()">Fechar</button>
    </div>
</div>

<div id="modalEditar" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <span class="close-modal" onclick="fecharModais()">√ó</span>
        <h3>Editar Informa√ß√µes e Observa√ß√µes</h3>
        <div class="grid-form">
            <div><label>Nome</label><input type="text" id="edit_nome"></div>
            <div><label>WhatsApp</label><input type="text" id="edit_tel"></div>
            <div><label>Data Agendamento</label><input type="date" id="edit_dataISO"></div>
            <div><label>Hora</label><input type="text" id="edit_hora"></div>
            <div><label>Instagram</label><input type="text" id="edit_insta"></div>
            <div><label>Cidade</label><input type="text" id="edit_cidade"></div>
            <div><label>Data Casamento</label><input type="text" id="edit_casamento"></div>
            <div><label>Or√ßamento</label><input type="text" id="edit_orcamento"></div>
            <div><label>CPF</label><input type="text" id="edit_cpf"></div>
            <div><label>Cerimonialista</label><input type="text" id="edit_cerimonialista"></div>
            <div><label>Finalidade</label><select id="edit_finalidade"><option value="Cerimonial">Cerimonial</option><option value="Civil">Civil</option><option value="Ambos">Ambos</option></select></div>
            <div><label>Refer√™ncias?</label><select id="edit_refs"><option value="Sim">Sim</option><option value="N√£o">N√£o</option></select></div>
            <div><label>Outras Lojas?</label><select id="edit_outras"><option value="Sim">Sim</option><option value="N√£o">N√£o</option></select></div>
            <div><label>Benef√≠cio?</label><select id="edit_beneficio"><option value="SIM">SIM</option><option value="N√ÉO">N√ÉO</option></select></div>
            <div id="divEditResultado" style="display:none;">
                <label>Resultado do Atendimento</label>
                <select id="edit_resultado">
                    <option value="alugou">Alugou Conosco</option>
                    <option value="nao_alugou">N√£o Alugou / Alugou no Concorrente</option>
                    <option value="remarcou">Ir√° Remarcar</option>
                </select>
            </div>
            <div id="divEditConcorrente" style="display:none;">
                <label>Onde ela alugou? (Concorrente)</label>
                <select id="edit_concorrente_select"></select>
            </div>
            <div style="grid-column: span 2;">
                <label>üìù Observa√ß√µes Internas (Somente a loja v√™)</label>
                <textarea id="edit_obs" rows="4" placeholder="Ex: Noiva vem com 4 acompanhantes, prefere estilo princesa..."></textarea>
            </div>
        </div>
        <button class="btn btn-novo" style="width:100%; margin-top:20px;" onclick="salvarEdicao()">Salvar Altera√ß√µes</button>
    </div>
</div>

<div id="modalFinalizar" class="modal">
    <div class="modal-content" style="max-width: 450px;">
        <span class="close-modal" onclick="fecharModais()">√ó</span>
        <h3>Encerrar Atendimento</h3>
        <label>Resultado</label>
        <select id="f_resultado" onchange="toggleConcorrente()">
            <option value="alugou">Alugou Conosco</option>
            <option value="nao_alugou">N√£o Alugou / Alugou no Concorrente</option>
            <option value="remarcou">Ir√° Remarcar</option>
        </select>
        <div id="divConcorrente" style="display:none; margin-top:15px;">
            <label>Onde ela alugou? (Concorrente)</label>
            <select id="f_concorrente_select">
                <option value="">N√£o soube informar</option>
            </select>
        </div>
        <button class="btn btn-novo" style="width:100%; margin-top:20px;" onclick="confirmarFinalizacao()">Confirmar</button>
    </div>
</div>

<div id="modalCadastro" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <span class="close-modal" onclick="fecharModais()">√ó</span>
        <h2 style="text-transform: uppercase; letter-spacing: 2px;">Nova Reserva Manual</h2>
        <form id="formManual">
            <div class="section-title">Log√≠stica do Atendimento</div>
            <div class="grid-form">
                <div><label>Data do Atendimento</label><input type="date" id="m_data" required onchange="buscarOcupacaoManual()"></div>
                <div><label>Hora</label><select id="m_hora" required><option value="">Selecione a data primeiro...</option></select></div>
            </div>
            <div class="section-title">Dados da Noiva</div>
            <div class="grid-form">
                <div><label>Nome Completo</label><input type="text" id="m_nome" required></div>
                <div><label>WhatsApp</label><input type="text" id="m_tel" oninput="mascaraTel(this)" required></div>
                <div><label>CPF</label><input type="text" id="m_cpf"></div>
                <div><label>Instagram</label><input type="text" id="m_insta" placeholder="@noiva"></div>
                <div><label>Cidade</label><input type="text" id="m_cidade"></div>
                <div><label>Data Casamento</label><input type="date" id="m_casamento"></div>
            </div>
            <div class="section-title">Perfil e Prefer√™ncias</div>
            <div class="grid-form">
                <div><label>Or√ßamento</label><input type="text" id="m_orcamento" placeholder="Ex: R$ 5.000,00"></div>
                <div><label>Cerimonialista</label><input type="text" id="m_cerimonialista"></div>
                <div><label>Finalidade</label><select id="m_finalidade"><option value="Cerimonial">Cerimonial</option><option value="Civil">Civil</option><option value="Ambos">Ambos</option></select></div>
                <div><label>Trouxe Refer√™ncias?</label><select id="m_refs"><option value="Sim">Sim</option><option value="N√£o">N√£o</option></select></div>
                <div><label>Visitou Outras Lojas?</label><select id="m_outras"><option value="N√£o">N√£o</option><option value="Sim">Sim</option></select></div>
                <div><label>Benef√≠cio 1¬™ Visita?</label><select id="m_beneficio"><option value="N√ÉO">N√ÉO</option><option value="SIM">SIM</option></select></div>
                <div style="grid-column: span 2;"><label>üìù Observa√ß√µes Iniciais</label><textarea id="m_obs" rows="2"></textarea></div>
            </div>
            <button type="button" class="btn btn-novo" style="width:100%; margin-top:30px;" onclick="salvarManual()">Confirmar Agendamento Interno</button>
        </form>
    </div>
</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyC8MacELfK0_avvpWIWBHZpJO_WYqhjOaE", authDomain: "exclusiva-noivas---agendamento.firebaseapp.com", databaseURL: "https://exclusiva-noivas---agendamento-default-rtdb.firebaseio.com", projectId: "exclusiva-noivas---agendamento", storageBucket: "exclusiva-noivas---agendamento.firebasestorage.app", messagingSenderId: "891467475836", appId: "1:891467475836:web:9565af78e44e9d6d53d2f9" };
    firebase.initializeApp(firebaseConfig); 
    const database = firebase.database();

    let statusAtual = 'pendente';
    let dataSelecionadaExpediente = "";
    let keySendoEditada = "";
    let chartConv = null;
    let chartRank = null;

    function verificarLogin() {
        const user = document.getElementById('userLogin').value;
        const pass = document.getElementById('passLogin').value;
        if(user === "Exclusiva" && pass === "Gael2025") {
            document.getElementById('loginOverlay').style.display = "none";
            document.getElementById('painelConteudo').style.display = "block";
            carregarDados();
            carregarLojistasSelect();
        } else { alert("Credenciais incorretas."); }
    }

    function hParaDec(s) { if(!s) return 0; let p = s.split(':'); return parseInt(p[0]) + (p[1] === "30" ? 0.5 : 0); }
    function formatarHora(d) { let h = Math.floor(d); let m = (d % 1 === 0) ? "00" : "30"; return `${h.toString().padStart(2, '0')}:${m}`; }
    function fecharModais() { document.querySelectorAll('.modal').forEach(m => m.style.display = "none"); }
    function toggleInputsEspecial() { document.getElementById('divHorariosEspeciais').style.display = (document.getElementById('e_status').value === 'especial') ? 'block' : 'none'; }
    function toggleConcorrente() { document.getElementById('divConcorrente').style.display = (document.getElementById('f_resultado').value === 'nao_alugou') ? 'block' : 'none'; }
    function mascaraTel(i) { let v = i.value.replace(/\D/g, ""); v = v.replace(/^(\d{2})(\d)/g, "($1) $2").replace(/(\d)(\d{4})$/, "$1-$2"); i.value = v; }

    function carregarDados() {
        const mesFiltro = document.getElementById('filtroMes').value;
        
        // Listener para Agendamentos
        database.ref('agendamentos').on('value', (snapshot) => {
            const container = document.getElementById('tabelaContainer');
            
            if(statusAtual === 'lojistas') { 
                document.getElementById('abaDashboardVisual').style.display = "none";
                renderLojistasAdmin(); return; 
            }
            if(statusAtual === 'dashboard') {
                document.getElementById('abaDashboardVisual').style.display = "block";
                container.innerHTML = "";
            } else {
                document.getElementById('abaDashboardVisual').style.display = "none";
            }

            let cAlugou = 0, cNaoAlugou = 0, cRemarcou = 0;
            let perdasPorLojista = {};
            let gruposAgendados = { hoje: [], amanha: [], daqui3: [], proximos: [] };
            let listaSimples = [];

            const hojeStr = new Date().toISOString().split('T')[0];
            const amanhaDate = new Date(); amanhaDate.setDate(amanhaDate.getDate() + 1);
            const amanhaStr = amanhaDate.toISOString().split('T')[0];
            const daqui3Date = new Date(); daqui3Date.setDate(daqui3Date.getDate() + 3);
            const daqui3Str = daqui3Date.toISOString().split('T')[0];

            snapshot.forEach(c => {
                let d = c.val(); d.key = c.key;
                let mesAtende = false;
                const mesAgend = d.dataISO ? d.dataISO.split('-')[1] : null;
                const mesDesejado = (parseInt(mesFiltro) + 1).toString().padStart(2, '0');

                if (statusAtual === 'pendente' || mesFiltro === 'todos') mesAtende = true;
                else if (mesAgend === mesDesejado) mesAtende = true;

                if (statusAtual !== 'dashboard') {
                    if (d.status === statusAtual || (statusAtual === 'agendado' && d.status === 'confirmado')) {
                        if (mesAtende) {
                            if (statusAtual === 'agendado') {
                                if (d.dataISO === hojeStr) gruposAgendados.hoje.push(d);
                                else if (d.dataISO === amanhaStr) gruposAgendados.amanha.push(d);
                                else if (d.dataISO === daqui3Str) gruposAgendados.daqui3.push(d);
                                else gruposAgendados.proximos.push(d);
                            } else {
                                listaSimples.push(d);
                            }
                        }
                    }
                }

                let mesAtendeEstat = (mesFiltro === 'todos') ? true : (mesAgend === mesDesejado);
                if (d.status === 'finalizado' && mesAtendeEstat) {
                    if (d.resultado === 'alugou') cAlugou++;
                    else if (d.resultado === 'nao_alugou') { 
                        cNaoAlugou++; 
                        if(d.concorrente) perdasPorLojista[d.concorrente] = (perdasPorLojista[d.concorrente] || 0) + 1;
                    }
                    else if (d.resultado === 'remarcou') cRemarcou++;
                }
            });

            atualizarDashboardVisual(cAlugou, cNaoAlugou, cRemarcou, perdasPorLojista);
            
            if(statusAtual === 'agendado') {
                container.innerHTML = "";
                container.innerHTML += renderBlocoTabela(gruposAgendados.hoje, "‚≠ê HOJE");
                container.innerHTML += renderBlocoTabela(gruposAgendados.amanha, "üìÖ AMANH√É");
                container.innerHTML += renderBlocoTabela(gruposAgendados.daqui3, "‚è≥ DAQUI A 3 DIAS");
                container.innerHTML += renderBlocoTabela(gruposAgendados.proximos, "üöÄ PR√ìXIMOS DIAS");
            } else if (statusAtual !== 'dashboard' && statusAtual !== 'lojistas') {
                renderTabela(listaSimples);
            }
        });

        // Carregar Cliques na Aba Dashboard
        if (statusAtual === 'dashboard') {
            database.ref('estatisticas/cliques').once('value', snapshot => {
                let totalAgenda = 0, totalWhats = 0, totalInsta = 0, totalMaps = 0;
                const mesDesejado = (parseInt(mesFiltro) + 1).toString().padStart(2, '0');

                snapshot.forEach(dataSnap => {
                    const dataKey = dataSnap.key; // formato YYYY-MM-DD
                    const mesKey = dataKey.split('-')[1];

                    if (mesFiltro === 'todos' || mesKey === mesDesejado) {
                        const v = dataSnap.val();
                        totalAgenda += v.agendar_horario || 0;
                        totalWhats += v.falar_consultora || 0;
                        totalInsta += v.instagram || 0;
                        totalMaps += v.localizacao || 0;
                    }
                });

                document.getElementById('clkAgenda').innerText = totalAgenda;
                document.getElementById('clkWhats').innerText = totalWhats;
                document.getElementById('clkInsta').innerText = totalInsta;
                document.getElementById('clkMaps').innerText = totalMaps;
            });
        }
    }

    function renderBlocoTabela(lista, titulo) {
        if (lista.length === 0) return "";
        lista.sort((a,b) => a.dataISO.localeCompare(b.dataISO) || a.hora.localeCompare(b.hora));
        let html = `<div class="group-header">${titulo}</div><table><thead><tr><th>Data/Hora</th><th>Noiva</th><th>WhatsApp</th><th>Status</th><th>A√ß√µes</th></tr></thead><tbody>`;
        lista.forEach(d => {
            const lembreteIcon = d.lembreteEnviado ? '<span class="badge-lembrete">‚úÖ</span>' : '';
            let botoes = `<button class="btn btn-info" onclick="verDetalhes('${encodeURIComponent(JSON.stringify(d))}')">Info</button>`;
            botoes += `<button class="btn btn-editar" onclick="abrirEdicao('${d.key}')">EDITAR</button>`;
            if(d.status === 'agendado') botoes += `<button class="btn btn-confirmar-final" onclick="mudarStatus('${d.key}', 'confirmado')">CONFIRMAR</button>`;
            botoes += `<button class="btn btn-whatsapp" onclick="enviarLembrete('${d.key}', '${d.tel}', '${d.nome}', '${d.dataISO}', '${d.hora}', '${d.beneficio || 'N√ÉO'}')">Lembrete ${lembreteIcon}</button>`;
            botoes += `<button class="btn btn-finalizar" onclick="abrirFinalizar('${d.key}')">FINALIZAR</button>`;
            botoes += `<button class="btn btn-recusar" onclick="mudarStatus('${d.key}', 'recusado')">CANCELAR</button>`;
            
            html += `<tr><td>${d.data} √†s ${d.hora}</td><td>${d.nome}</td><td>${d.tel}</td><td class="status-${d.status}">${d.status.toUpperCase()}</td><td>${botoes}</td></tr>`;
        });
        return html + "</tbody></table>";
    }

    function atualizarDashboardVisual(alugou, nao, remarca, perdas) {
        const total = alugou + nao + remarca;
        document.getElementById('statTotal').innerText = total;
        document.getElementById('statAluguel').innerText = alugou;
        document.getElementById('statConv').innerText = total > 0 ? Math.round((alugou/total)*100) + "%" : "0%";

        if (statusAtual !== 'dashboard') return;

        if (chartConv) chartConv.destroy();
        chartConv = new Chart(document.getElementById('chartConversao'), {
            type: 'doughnut',
            data: {
                labels: ['Alugou', 'N√£o Alugou', 'Remarcou'],
                datasets: [{ data: [alugou, nao, remarca], backgroundColor: ['#2ecc71', '#ff4d4d', '#f1c40f'] }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        const labelsLojistas = Object.keys(perdas);
        const valoresLojistas = Object.values(perdas);
        if (chartRank) chartRank.destroy();
        chartRank = new Chart(document.getElementById('chartRanking'), {
            type: 'bar',
            data: {
                labels: labelsLojistas,
                datasets: [{ label: 'Noivas Perdidas', data: valoresLojistas, backgroundColor: '#b89754' }]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
        });
    }

    function carregarLojistasSelect() {
        database.ref('configuracoes/lojistas').on('value', snap => {
            const selectFinalizar = document.getElementById('f_concorrente_select');
            const selectEditar = document.getElementById('edit_concorrente_select');
            
            let html = '<option value="">N√£o soube informar</option>';
            snap.forEach(l => {
                html += `<option value="${l.val().nome}">${l.val().nome}</option>`;
            });
            
            selectFinalizar.innerHTML = html;
            selectEditar.innerHTML = html;
        });
    }

    function renderLojistasAdmin() {
        const container = document.getElementById('tabelaContainer');
        container.innerHTML = `
            <div class="group-header">Gerenciar Concorrentes</div>
            <div style="background:#fff; padding:20px; border:1px solid #eee; margin-bottom:20px; text-align:left;">
                <label>Cadastrar Novo Lojista Concorrente</label>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="novo_lojista" placeholder="Ex: Loja das Noivas" style="flex:1;">
                    <button class="btn btn-novo" onclick="salvarLojista()" style="margin:0;">Cadastrar</button>
                </div>
            </div>
            <div id="listaLojistas"></div>
        `;
        database.ref('configuracoes/lojistas').on('value', snap => {
            const lista = document.getElementById('listaLojistas');
            lista.innerHTML = "";
            snap.forEach(l => {
                lista.innerHTML += `
                    <div class="lojista-item"><span>${l.val().nome}</span><button class="btn btn-recusar" onclick="removerLojista('${l.key}')">Excluir</button></div>
                `;
            });
        });
    }

    function salvarLojista() {
        const nome = document.getElementById('novo_lojista').value;
        if(!nome) return;
        database.ref('configuracoes/lojistas').push({ nome: nome }).then(() => { document.getElementById('novo_lojista').value = ""; });
    }
    function removerLojista(key) { if(confirm("Remover este lojista?")) database.ref('configuracoes/lojistas/' + key).remove(); }

    function renderTabela(lista) {
        const container = document.getElementById('tabelaContainer');
        if (lista.length === 0) { container.innerHTML = "<p style='text-align:center; padding:40px;'>Nenhum registro encontrado.</p>"; return; }
        lista.sort((a,b) => a.dataISO.localeCompare(b.dataISO) || a.hora.localeCompare(b.hora));
        let html = `<table><thead><tr><th>Data/Hora</th><th>Noiva</th><th>WhatsApp</th><th>Status</th><th>A√ß√µes</th></tr></thead><tbody>`;
        lista.forEach(d => {
            // INFO E EDITAR AGORA FICAM SEMPRE DISPON√çVEIS
            let botoes = `<button class="btn btn-info" onclick="verDetalhes('${encodeURIComponent(JSON.stringify(d))}')">Info</button>`;
            botoes += `<button class="btn btn-editar" onclick="abrirEdicao('${d.key}')">EDITAR</button>`;

            if (d.status === 'pendente') {
                botoes += `<button class="btn btn-aceitar" onclick="mudarStatus('${d.key}', 'agendado')">ACEITAR</button>`;
                botoes += `<button class="btn btn-recusar" onclick="mudarStatus('${d.key}', 'recusado')">X</button>`;
            } else if (d.status === 'recusado') {
                botoes += `<button class="btn btn-reativar" onclick="mudarStatus('${d.key}', 'pendente')">REATIVAR</button>`;
            } else if (d.status === 'finalizado') {
                botoes += `<span style="font-size:10px; margin-left:10px; color:var(--gold); font-weight:bold;">[${d.resultado ? d.resultado.toUpperCase() : 'FINALIZADO'} ${d.concorrente ? '('+d.concorrente+')' : ''}]</span>`;
            }
            html += `<tr><td>${d.data} √†s ${d.hora}</td><td>${d.nome}</td><td>${d.tel}</td><td class="status-${d.status}">${d.status.toUpperCase()}</td><td>${botoes}</td></tr>`;
        });
        container.innerHTML = html + "</tbody></table>";
    }

    function enviarLembrete(key, tel, nome, dataISO, hora, beneficio) {
        const fone = tel.replace(/\D/g, "");
        const dataObj = new Date(dataISO + "T00:00:00");
        const diasSemana = ["Domingo", "Segunda-feira", "Ter√ßa-feira", "Quarta-feira", "Quinta-feira", "Sexta-feira", "S√°bado"];
        const diaSemana = diasSemana[dataObj.getDay()];
        const dataBR = dataISO.split('-').reverse().join('/');
        
        let msg = `*LEMBRETE DE AGENDAMENTO*%0A*Exclusiva Noivas*%0A%0A`;
        msg += `üë∞‚Äç‚ôÄÔ∏è*Noiva:* ${nome}%0A`;
        msg += `üìÖ*Data do Agendamento:* ${dataBR} (${diaSemana})%0A`;
        msg += `üïõ*Hor√°rio:* ${hora}hs%0A%0A`;
        msg += `*Benef√≠cio de Primeira Visita:* ${beneficio === 'SIM' ? '‚úÖ Ativo' : 'N√£o se aplica'}%0A%0A`;
        msg += `üìç*Endere√ßo:* Avenida Rio Branco, 481 - Mar√≠lia/SP%0A`;
        msg += `*Temos estacionamento em frente √† loja.*%0A%0A`;
        msg += `Podemos confirmar seu hor√°rio? ‚ú®`;

        database.ref('agendamentos/' + key).update({ lembreteEnviado: true });
        window.open(`https://wa.me/55${fone}?text=${msg}`, '_blank');
    }

    function verDetalhes(jsonStr) {
        const d = JSON.parse(decodeURIComponent(jsonStr));
        document.getElementById('detalheNome').innerText = d.nome;
        document.getElementById('detalheData').innerText = `${d.data} √†s ${d.hora}`;
        document.getElementById('detalhesNoiva').innerHTML = `
            <div class="info-card-item"><span class="info-card-label">WhatsApp</span>${d.tel}</div>
            <div class="info-card-item"><span class="info-card-label">CPF</span>${d.cpf || '-'}</div>
            <div class="info-card-item"><span class="info-card-label">Cidade</span>${d.cidade || '-'}</div>
            <div class="info-card-item"><span class="info-card-label">Casamento</span>${d.casamento || '-'}</div>
            <div class="info-card-item"><span class="info-card-label">Instagram</span>${d.insta || '-'}</div>
            <div class="info-card-item"><span class="info-card-label">Estilo</span>${d.finalidade || '-'}</div>
            <div class="info-card-item"><span class="info-card-label">Or√ßamento</span>${d.orcamento || '-'}</div>
            <div class="info-card-item"><span class="info-card-label">Cerimonialista</span>${d.cerimonialista || '-'}</div>
            <div class="info-card-item"><span class="info-card-label">Refer√™ncias</span>${d.refs || '-'}</div>
            <div class="info-card-item"><span class="info-card-label">Outras Lojas</span>${d.outras || '-'}</div>
            <div class="info-card-item"><span class="info-card-label">Benef√≠cio</span>${d.beneficio || '-'}</div>
            <div class="obs-box" style="${d.obs ? '' : 'display:none'}"><span class="info-card-label">Observa√ß√µes Internas:</span>${d.obs || ''}</div>
        `;
        document.getElementById('modalDetalhes').style.display = "flex";
    }

    function abrirEdicao(key) {
        keySendoEditada = key;
        database.ref('agendamentos/' + key).once('value', snap => {
            const d = snap.val();
            document.getElementById('edit_nome').value = d.nome || "";
            document.getElementById('edit_tel').value = d.tel || "";
            document.getElementById('edit_dataISO').value = d.dataISO || "";
            document.getElementById('edit_hora').value = d.hora || "";
            document.getElementById('edit_insta').value = d.insta || "";
            document.getElementById('edit_cidade').value = d.cidade || "";
            document.getElementById('edit_casamento').value = d.casamento || "";
            document.getElementById('edit_orcamento').value = d.orcamento || "";
            document.getElementById('edit_cpf').value = d.cpf || "";
            document.getElementById('edit_cerimonialista').value = d.cerimonialista || "";
            document.getElementById('edit_finalidade').value = d.finalidade || "Cerimonial";
            document.getElementById('edit_refs').value = d.refs || "N√£o";
            document.getElementById('edit_outras').value = d.outras || "N√£o";
            document.getElementById('edit_beneficio').value = d.beneficio || "N√ÉO";
            document.getElementById('edit_obs').value = d.obs || "";
            
            // EXIBIR CAMPOS DE RESULTADO SE J√Å ESTIVER FINALIZADO
            if(d.status === 'finalizado') {
                document.getElementById('divEditResultado').style.display = "block";
                document.getElementById('divEditConcorrente').style.display = "block";
                document.getElementById('edit_resultado').value = d.resultado || "alugou";
                document.getElementById('edit_concorrente_select').value = d.concorrente || "";
            } else {
                document.getElementById('divEditResultado').style.display = "none";
                document.getElementById('divEditConcorrente').style.display = "none";
            }
            
            document.getElementById('modalEditar').style.display = "flex";
        });
    }

    function salvarEdicao() {
        const dISO = document.getElementById('edit_dataISO').value;
        const up = {
            nome: document.getElementById('edit_nome').value, tel: document.getElementById('edit_tel').value,
            dataISO: dISO, data: dISO.split('-').reverse().join('/'), hora: document.getElementById('edit_hora').value,
            insta: document.getElementById('edit_insta').value, cidade: document.getElementById('edit_cidade').value,
            casamento: document.getElementById('edit_casamento').value, orcamento: document.getElementById('edit_orcamento').value,
            cpf: document.getElementById('edit_cpf').value, cerimonialista: document.getElementById('edit_cerimonialista').value,
            finalidade: document.getElementById('edit_finalidade').value, refs: document.getElementById('edit_refs').value,
            outras: document.getElementById('edit_outras').value, beneficio: document.getElementById('edit_beneficio').value,
            obs: document.getElementById('edit_obs').value
        };

        // SALVAR RESULTADOS SE ESTIVEREM VIS√çVEIS
        if(document.getElementById('divEditResultado').style.display === "block") {
            up.resultado = document.getElementById('edit_resultado').value;
            up.concorrente = document.getElementById('edit_concorrente_select').value;
        }

        database.ref('agendamentos/' + keySendoEditada).update(up).then(() => fecharModais());
    }

    function salvarManual() {
        const dISO = document.getElementById('m_data').value;
        const cISO = document.getElementById('m_casamento').value;
        const d = { 
            data: dISO.split('-').reverse().join('/'), dataISO: dISO, hora: document.getElementById('m_hora').value, 
            nome: document.getElementById('m_nome').value, tel: document.getElementById('m_tel').value, 
            cpf: document.getElementById('m_cpf').value, insta: document.getElementById('m_insta').value,
            cidade: document.getElementById('m_cidade').value, casamento: cISO ? cISO.split('-').reverse().join('/') : "-",
            orcamento: document.getElementById('m_orcamento').value, cerimonialista: document.getElementById('m_cerimonialista').value,
            finalidade: document.getElementById('m_finalidade').value, refs: document.getElementById('m_refs').value,
            outras: document.getElementById('m_outras').value, beneficio: document.getElementById('m_beneficio').value,
            obs: document.getElementById('m_obs').value,
            status: "agendado", timestamp: new Date().toISOString() 
        };
        database.ref('agendamentos').push().set(d).then(() => { alert("Agendamento Manual Realizado!"); fecharModais(); document.getElementById('formManual').reset(); });
    }

    function buscarOcupacaoManual() {
        const dataSel = document.getElementById('m_data').value;
        if(!dataSel) return;
        database.ref('agendamentos').orderByChild('dataISO').equalTo(dataSel).once('value', snap => {
            let ocup = []; snap.forEach(c => { if(c.val().status !== 'recusado') ocup.push(c.val().hora); });
            const select = document.getElementById('m_hora'); select.innerHTML = "";
            const ds = new Date(dataSel + "T00:00:00").getDay();
            let inicio = 9, fim = 18;
            if(ds === 6) fim = 16;
            if(ds === 0) { select.innerHTML = "<option>Domingo Fechado</option>"; return; }
            for (let h = inicio; h <= fim; h += 0.5) {
                let horaStr = formatarHora(h);
                let opt = document.createElement("option"); opt.value = horaStr; opt.text = ocup.includes(horaStr) ? horaStr + " (OCUPADO)" : horaStr;
                if(ocup.includes(horaStr)) opt.disabled = true;
                select.add(opt);
            }
        });
    }

    function mudarStatus(key, status) { database.ref('agendamentos/' + key).update({ status: status }); }
    function abrirFinalizar(key) { keySendoEditada = key; document.getElementById('modalFinalizar').style.display = "flex"; }
    function confirmarFinalizacao() {
        const res = document.getElementById('f_resultado').value;
        const conc = document.getElementById('f_concorrente_select').value;
        database.ref('agendamentos/' + keySendoEditada).update({ status: 'finalizado', resultado: res, concorrente: conc }).then(() => fecharModais());
    }

    function abrirModalExpediente() { document.getElementById('modalExpediente').style.display = "flex"; gerarCalendarioVisivel(); }
    function gerarCalendarioVisivel() {
        const mes = parseInt(document.getElementById('filtroMesCalendario')?.value || new Date().getMonth());
        const ano = 2026;
        const primeiroDia = new Date(ano, mes, 1).getDay();
        const diasNoMes = new Date(ano, mes + 1, 0).getDate();
        const corpo = document.getElementById('corpoCalendario');
        corpo.innerHTML = "";
        Promise.all([database.ref('expediente/config').once('value'), database.ref('agendamentos').once('value')]).then(([snapConfig, snapAgend]) => {
            const configs = snapConfig.val() || {};
            const agendamentos = snapAgend.val() || {};
            let contagem = {};
            Object.values(agendamentos).forEach(a => { if(a.status === 'agendado' || a.status === 'confirmado') contagem[a.dataISO] = (contagem[a.dataISO] || 0) + 1; });
            for (let i = 0; i < primeiroDia; i++) corpo.innerHTML += `<div></div>`;
            for (let dia = 1; dia <= diasNoMes; dia++) {
                const dISO = `${ano}-${(mes + 1).toString().padStart(2, '0')}-${dia.toString().padStart(2, '0')}`;
                const conf = configs[dISO] || { status: 'padrao' };
                const qtd = contagem[dISO] || 0;
                let classe = "dia-padrao"; let labelHora = "09:30-17:00";
                const ds = new Date(dISO + "T00:00:00").getDay();
                if (conf.status === 'fechado' || ds === 0) { classe = "dia-fechado"; labelHora = "FECHADO"; }
                else if (conf.status === 'especial') { classe = "dia-longo"; labelHora = conf.inicio + "-" + conf.fim; }
                else if (ds === 6) { classe = (dia <= 14) ? "dia-longo" : "dia-curto"; labelHora = (dia <= 14) ? "09:00-16:00" : "09:00-12:00"; }
                corpo.innerHTML += `<div class="cal-day ${classe}" onclick="ajustarDia('${dISO}')"><b>${dia}</b><span style="font-size:8px;">${labelHora}</span><span class="agendamento-count">${qtd}</span></div>`;
            }
        });
    }
    function ajustarDia(data) { dataSelecionadaExpediente = data; document.getElementById('tituloDiaEspecial').innerText = data; document.getElementById('modalDiaEspecial').style.display = "flex"; }
    function salvarConfigDia() {
        const conf = { status: document.getElementById('e_status').value, inicio: document.getElementById('e_inicio').value, fim: document.getElementById('e_fim').value };
        database.ref('expediente/config/' + dataSelecionadaExpediente).set(conf).then(() => { fecharModais(); gerarCalendarioVisivel(); });
    }

    function filtrarStatus(status, btn) {
        statusAtual = status;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('filtroDataContainer').style.display = (status === 'pendente' || status === 'lojistas') ? 'none' : 'flex';
        carregarDados();
    }

    function abrirModalCadastro() { document.getElementById('formManual').reset(); document.getElementById('m_hora').innerHTML = "<option value=''>Selecione a data primeiro...</option>"; document.getElementById('modalCadastro').style.display = "flex"; }
</script>
</body>
</html>

